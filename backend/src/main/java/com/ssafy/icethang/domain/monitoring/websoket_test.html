<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>IceThang WebSocket Tester</title>
    <!-- SockJS & Stomp ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .container { display: flex; gap: 20px; }
        .box { border: 1px solid #ccc; padding: 20px; width: 45%; border-radius: 8px; }
        h3 { margin-top: 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { margin-bottom: 10px; width: 100%; padding: 5px; box-sizing: border-box;}
        button { cursor: pointer; padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px;}
        button:disabled { background-color: #ccc; }
        #messages { height: 300px; overflow-y: scroll; background: #f0f0f0; border: 1px solid #999; padding: 10px; margin-top: 10px;}
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #ddd; padding-bottom: 2px; }
        .server-config { background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ced4da; }
    </style>
</head>
<body>
<h2>ğŸ¥¶ IceThang ì‹¤ì‹œê°„ ì•ŒëŒ í…ŒìŠ¤íŠ¸</h2>

<div class="server-config">
    <label>ğŸ”Œ ì„œë²„ ì£¼ì†Œ (í¬íŠ¸ í™•ì¸ í•„ìˆ˜!)</label>
    <div style="display: flex; gap: 10px;">
        <input type="text" id="serverUrl" value="http://localhost:8080/ws" style="width: 70%;">
        <button id="connectBtn" onclick="connect()" style="width: 15%;">ì—°ê²° (Connect)</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled style="width: 15%; background-color: #6c757d;">í•´ì œ</button>
    </div>
    <div id="status" style="margin-top: 5px; font-weight: bold; color: red;">â— ì—°ê²° ëŠê¹€</div>
</div>

<div class="container">
    <!-- ì„ ìƒë‹˜ ì˜ì—­ (ìˆ˜ì‹ ) -->
    <div class="box">
        <h3>ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ (ìˆ˜ì‹ )</h3>
        <label>êµ¬ë…í•  ë°˜ ID (Class ID)</label>
        <input type="number" id="subClassId" value="1" placeholder="ì˜ˆ: 1">
        <button onclick="subscribe()">2. ì•ŒëŒ êµ¬ë…í•˜ê¸° (Subscribe)</button>

        <h4>ğŸ“¥ ìˆ˜ì‹ ëœ ì•ŒëŒ ë¡œê·¸</h4>
        <div id="messages"></div>
    </div>

    <!-- í•™ìƒ ì˜ì—­ (ë°œì‹ ) -->
    <div class="box">
        <h3>ğŸ‘¶ í•™ìƒ (ë°œì‹ )</h3>
        <label>ë³´ë‚¼ ë°˜ ID (Class ID)</label>
        <input type="number" id="pubClassId" value="1" placeholder="ì„ ìƒë‹˜ì´ë‘ ê°™ì€ IDì—¬ì•¼ í•¨">

        <label>í•™ìƒ ID</label>
        <input type="number" id="studentId" value="101">

        <label>í•™ìƒ ì´ë¦„</label>
        <input type="text" id="studentName" value="ê¹€ì‹¸í”¼">

        <label>ì•ŒëŒ ì¢…ë¥˜ (Alert Type)</label>
        <select id="alertType">
            <option value="FOCUS">ì§‘ì¤‘ ì¤‘ (FOCUS)</option>
            <option value="UNFOCUS">ì§‘ì¤‘ ì•ˆí•˜ëŠ”ë“¯ (COMPLETELY_OUT)</option>
            <option value="AWAY">ë„ë§ê° (AWAY)</option>
        </select>

        <button onclick="sendAlert()" style="background-color: #dc3545;">3. ì•ŒëŒ ë³´ë‚´ê¸° (Send)</button>
    </div>
</div>

<script>
    var stompClient = null;

    function connect() {
        var url = document.getElementById('serverUrl').value;
        console.log("Connecting to: " + url);

        // [UI ì—…ë°ì´íŠ¸] ë²„íŠ¼ ëˆ„ë¥´ìë§ˆì ë°˜ì‘ ë³´ì—¬ì£¼ê¸°
        document.getElementById('connectBtn').disabled = true;
        document.getElementById('status').innerHTML = "â³ ì—°ê²° ì‹œë„ ì¤‘...";
        document.getElementById('status').style.color = "orange";
        appendLog("â³ ì‹œìŠ¤í…œ: " + url + " ë¡œ ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤...");

        var socket = new SockJS(url);
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            setConnected(true);
            console.log('Connected: ' + frame);
            appendLog("âœ… ì‹œìŠ¤í…œ: ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }, function (error) {
            console.log(error);
            setConnected(false); // ì‹¤íŒ¨ ì‹œ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
            appendLog("âŒ ì‹œìŠ¤í…œ: ì—°ê²° ì‹¤íŒ¨! ì„œë²„ í¬íŠ¸(8081/8082)ì™€ SecurityConfig ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”. (" + error + ")");
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        setConnected(false);
        appendLog("ğŸ›‘ ì‹œìŠ¤í…œ: ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function setConnected(connected) {
        document.getElementById('connectBtn').disabled = connected;
        document.getElementById('disconnectBtn').disabled = !connected;
        document.getElementById('serverUrl').disabled = connected; // ì—°ê²°ë˜ë©´ ì£¼ì†Œ ìˆ˜ì • ë¶ˆê°€

        var statusSpan = document.getElementById('status');
        if(connected) {
            statusSpan.innerHTML = "â— ì—°ê²°ë¨ (Online)";
            statusSpan.style.color = "green";
        } else {
            statusSpan.innerHTML = "â— ì—°ê²° ëŠê¹€ (Offline)";
            statusSpan.style.color = "red";
        }
    }

    function subscribe() {
        if(!stompClient || !stompClient.connected) {
            alert("ë¨¼ì € ì†Œì¼“ ì—°ê²°ì„ í•´ì£¼ì„¸ìš”!");
            return;
        }

        var classId = document.getElementById('subClassId').value;
        stompClient.subscribe('/topic/class/' + classId, function (message) {
            showAlert(JSON.parse(message.body));
        });

        appendLog("ğŸ“¡ ì‹œìŠ¤í…œ: [" + classId + "ë°˜] ì•ŒëŒì„ êµ¬ë…í•©ë‹ˆë‹¤.");
    }

    function sendAlert() {
        if(!stompClient || !stompClient.connected) {
            alert("ë¨¼ì € ì†Œì¼“ ì—°ê²°ì„ í•´ì£¼ì„¸ìš”!");
            return;
        }

        var classId = document.getElementById('pubClassId').value;
        var studentId = document.getElementById('studentId').value;
        var name = document.getElementById('studentName').value;
        var type = document.getElementById('alertType').value;

        var payload = {
            classId: classId,
            studentId: studentId,
            studentName: name,
            type: type
        };

        stompClient.send("/app/alert", {}, JSON.stringify(payload));
        console.log("ë³´ëƒ„: ", payload);
        // appendLog("ğŸ“¤ ë°œì‹ : " + name + " (" + type + ")"); // ë‚´ê°€ ë³´ë‚¸ ê±´ ë¡œê·¸ì— ì•ˆ ì°ì–´ë„ ë¨ (ìˆ˜ì‹  í™•ì¸ì´ ì¤‘ìš”í•˜ë‹ˆê¹Œ)
    }

    function showAlert(alertData) {
        var color = alertData.type === 'COMPLETELY_OUT' ? 'red' : 'orange';
        var message = `[ë°˜: ${alertData.classId}] <b>${alertData.studentName}</b>: <span style="color:${color}; font-weight:bold;">${alertData.type}</span>`;
        appendLog(message);
    }

    function appendLog(messageHTML) {
        var messagesDiv = document.getElementById('messages');
        var msgElement = document.createElement('div');
        msgElement.className = 'log-entry';
        msgElement.innerHTML = `<small style="color:#666;">[${new Date().toLocaleTimeString()}]</small> ${messageHTML}`;
        messagesDiv.appendChild(msgElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>
</body>
</html>